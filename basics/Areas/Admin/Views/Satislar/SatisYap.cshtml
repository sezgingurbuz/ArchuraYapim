@model basics.Areas.Admin.Models.Etkinlik
@{
    ViewData["Title"] = "Bilet Satƒ±≈ü - " + Model.EtkinlikAdi;
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var biletler = ViewBag.Biletler as List<basics.Areas.Admin.Models.EtkinlikKoltuk>;
    var toplamKategoriBilet = ViewBag.ToplamKategoriBilet as int? ?? 0;
    var atanmamisKategoriBilet = ViewBag.AtanmamisKategoriBilet as int? ?? 0;
}

<div class="container-fluid py-4">
    <!-- Gƒ∞≈ûE HEADER - Modern Tasarƒ±m -->
    <div class="gise-header mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <!-- Sol: Sidebar Toggle -->
            <button class="btn btn-light btn-lg rounded-circle shadow-sm" onclick="toggleSidebar()" title="Men√ºy√º Gizle/G√∂ster" style="width: 50px; height: 50px;">
                <i class="fa-solid fa-bars"></i>
            </button>
            
            <!-- Orta: Etkinlik Bilgisi -->
            <div class="text-center flex-grow-1">
                <div class="text-uppercase small text-muted mb-1" style="letter-spacing: 2px; font-weight: 600;">Gi≈üe Satƒ±≈ü Ekranƒ±</div>
                <h4 class="mb-0 fw-bold" style="color: #1a1f2e;">@Model.EtkinlikAdi</h4>
                <div class="text-muted small mt-1">
                    <i class="fa-solid fa-location-dot me-1"></i>@Model.Salon?.SalonAdi
                    <span class="mx-2">‚Ä¢</span>
                    <i class="fa-solid fa-calendar me-1"></i>@Model.TarihSaat.ToString("dd MMM yyyy, HH:mm")
                </div>
            </div>
            
            <!-- Saƒü: Geri D√∂n -->
            <a asp-action="Index" class="btn btn-dark rounded-pill px-4 py-2">
                <i class="fa-solid fa-arrow-left me-2"></i>Listeye D√∂n
            </a>
        </div>
    </div>

    <style>
        .gise-header {
            background: white;
            border-radius: 20px;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .platform-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
        }
        .platform-card .card-header {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            border: none;
        }
        .platform-btn {
            padding: 0.875rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            border-width: 2px;
        }
        .platform-btn:hover {
            transform: translateY(-2px);
        }
        .form-control, .form-select {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.2s;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }
        .btn-sale-complete {
            background: linear-gradient(135deg, #198754 0%, #157347 100%);
            border: none;
            padding: 1rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(25, 135, 84, 0.35);
            transition: all 0.3s;
        }
        .btn-sale-complete:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(25, 135, 84, 0.45);
        }
        .seating-card {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: none;
        }
        .seating-card .card-header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
        }
        .rezervasyon-card {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border: none;
            border-radius: 16px;
            overflow: hidden;
        }
        .rezervasyon-card .card-header {
            background: #ffc107;
            color: #1a1f2e;
            border: none;
            font-weight: 700;
        }
        .alert-modern {
            border-radius: 12px;
            border: none;
        }
    </style>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-modern alert-dismissible fade show">
            <i class="fa-solid fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-modern alert-dismissible fade show">
            <i class="fa-solid fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* KATEGORƒ∞ Bƒ∞LET Bƒ∞LGƒ∞ KARTI *@
    @if (Model.SatisTipi == "Kategori" && toplamKategoriBilet > 0)
    {
        <div class="alert alert-modern @(atanmamisKategoriBilet > 0 ? "alert-warning" : "alert-success") mb-4">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div>
                    <h5 class="mb-1"><i class="fa-solid fa-tags me-2"></i>Kategori Bilet Durumu</h5>
                    <p class="mb-0">
                        <strong>@atanmamisKategoriBilet</strong> adet bilet koltuk atamasƒ± bekliyor
                        (Toplam: @toplamKategoriBilet bilet satƒ±ldƒ±)
                    </p>
                </div>
                @if (atanmamisKategoriBilet > 0)
                {
                    <span class="badge bg-warning text-dark fs-5 px-3 py-2 rounded-pill">
                        <i class="fa-solid fa-clock me-1"></i>@atanmamisKategoriBilet Bekliyor
                    </span>
                }
                else
                {
                    <span class="badge bg-success fs-5 px-3 py-2 rounded-pill">
                        <i class="fa-solid fa-check me-1"></i>T√ºm√º Atandƒ±
                    </span>
                }
            </div>
        </div>
    }

    <!-- REZERVASYON KODU ARAMA -->
    <div class="card rezervasyon-card mb-4">
        <div class="card-header py-3">
            <h5 class="m-0"><i class="fa-solid fa-search me-2"></i>Rezervasyon Kodu ile Koltuk Atama</h5>
        </div>
        <div class="card-body" style="background: white;">
            <div class="row align-items-end g-3">
                <div class="col-md-5">
                    <label class="form-label fw-bold text-dark">Rezervasyon Kodu</label>
                    <input type="text" id="rezervasyonKoduInput" class="form-control form-control-lg" 
                           placeholder="√ñrn: RZV-ABC12345" style="text-transform: uppercase;" />
                </div>
                <div class="col-md-3">
                    <button type="button" id="rezervasyonAraBtn" class="btn btn-warning btn-lg w-100 fw-bold" style="border-radius: 12px;">
                        <i class="fa-solid fa-search me-2"></i>Ara
                    </button>
                </div>
                <div class="col-md-4">
                    <div id="rezervasyonSonuc" style="display: none;"></div>
                </div>
            </div>
            
            <div id="biletBilgileri" class="mt-4" style="display: none;">
                <div class="alert alert-success alert-modern">
                    <div class="row">
                        <div class="col-md-8">
                            <h6><i class="fa-solid fa-user me-2"></i>M√º≈üteri Bilgileri</h6>
                            <p class="mb-1"><strong>Ad Soyad:</strong> <span id="musteriAdSoyad"></span></p>
                            <p class="mb-1"><strong>Telefon:</strong> <span id="musteriTel"></span></p>
                            <p class="mb-1"><strong>Kategori:</strong> <span id="kategoriAdi"></span></p>
                            <p class="mb-0"><strong>Fiyat:</strong> <span id="biletFiyati"></span> ‚Ç∫</p>
                        </div>
                        <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
                            <a id="koltukAtamaLink" href="#" class="btn btn-success btn-lg rounded-pill px-4">
                                <i class="fa-solid fa-chair me-2"></i>Koltuk Ata
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- KOLTUK D√úZENƒ∞ (SOL) -->
        <div class="col-lg-8">
            <div class="card seating-card" id="seating-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0 fw-bold"><i class="fa-solid fa-couch me-2 text-primary"></i>Koltuk Se√ßimi</h5>
                    <button type="button" class="btn btn-outline-dark btn-sm rounded-pill px-3" id="fullscreenBtn" onclick="toggleFullscreen()">
                        <i class="fa-solid fa-expand me-1"></i> <span>Tam Ekran</span>
                    </button>
                </div>
                <div class="card-body bg-light text-center p-4" id="seating-body">
                    <div id="seating-area">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Y√ºkleniyor...</span>
                        </div>
                    </div>

                    <div class="stage-mb-4 mx-auto bg-dark text-white rounded-pill py-2 px-5 mb-4" style="max-width: 500px; font-weight: 600; letter-spacing: 2px;">
                        SAHNE
                    </div>

                    <div class="d-flex justify-content-center gap-4 mt-4 flex-wrap p-3 bg-white rounded-3" id="legend-area">
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-secondary me-2"></div> <span class="small fw-medium">Bo≈ü</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-primary me-2"></div> <span class="small fw-medium">Se√ßili</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-success me-2"></div> <span class="small fw-medium">Bubilet</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-warning me-2"></div> <span class="small fw-medium">Biletinial</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-danger me-2"></div> <span class="small fw-medium">Satƒ±lmƒ±≈ü</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SATI≈û FORMU (SAƒû) -->
        <div class="col-lg-4">
            <div class="card platform-card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="m-0 fw-bold"><i class="fa-solid fa-cash-register me-2"></i>Satƒ±≈ü Bilgileri</h5>
                </div>
                <div class="card-body p-4">
                    <!-- PLATFORM SE√áƒ∞Mƒ∞ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-muted small text-uppercase" style="letter-spacing: 0.5px;">Satƒ±≈ü Platformu</label>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-dark platform-btn" data-platform="Archura">
                                <i class="fa-solid fa-globe me-2"></i>Archura (Direkt Satƒ±≈ü)
                            </button>
                            <button type="button" class="btn btn-outline-success platform-btn" data-platform="Bubilet">
                                <i class="fa-solid fa-ticket me-2"></i>Bubilet
                            </button>
                            <button type="button" class="btn btn-outline-warning platform-btn" data-platform="Biletinial">
                                <i class="fa-solid fa-ticket-alt me-2"></i>Biletinial
                            </button>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <form asp-action="SatisYap" method="post" id="salesForm">
                        <input type="hidden" name="etkinlikId" value="@Model.Id" />
                        <input type="hidden" name="satisPlatformu" id="selectedPlatform" value="Archura" />
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Se√ßilen Koltuklar</label>
                            <input type="text" name="koltuklar" id="selectedSeats" class="form-control" 
                                   placeholder="Koltuk se√ßiniz..." readonly required style="background: #f8f9fa;" />
                            <small class="text-muted">Soldaki plan √ºzerinden koltuk se√ßin</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Bilet Fiyatƒ± (‚Ç∫)</label>
                            <input type="number" name="fiyat" class="form-control" 
                                   placeholder="100" step="0.01" min="0" required />
                        </div>

                        <hr class="my-4" />

                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label fw-bold">Ad <span class="text-danger">*</span></label>
                                <input type="text" name="musteriAdi" class="form-control" 
                                       placeholder="Ad" required />
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Soyad <span class="text-danger">*</span></label>
                                <input type="text" name="musteriSoyadi" class="form-control" 
                                       placeholder="Soyad" required />
                            </div>
                        </div>

                        <div class="mb-3 mt-3">
                            <label class="form-label fw-bold">Telefon <span class="text-danger">*</span></label>
                            <input type="tel" name="musteriTelefon" class="form-control" 
                                   placeholder="05xx xxx xx xx" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">E-mail</label>
                            <input type="email" name="musteriEmail" class="form-control" 
                                   placeholder="musteri@example.com" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">√ñdeme Y√∂ntemi</label>
                            <select name="odemeYontemi" class="form-select" required>
                                <option value="">Se√ßiniz...</option>
                                <option value="Nakit">üíµ Nakit</option>
                                <option value="Kart">üí≥ Kart</option>
                                <option value="EFT">üè¶ EFT</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-success btn-sale-complete w-100">
                            <i class="fa-solid fa-check me-2"></i>Satƒ±≈üƒ± Tamamla
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
    .seat-row {
        gap: 8px;
    }
    .seat {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        color: white;
        font-weight: 600;
    }
    .seat:hover:not(.sold) {
        transform: scale(1.1);
        z-index: 10;
    }
    .seat.empty { 
        background-color: #6c757d; 
    }
    .seat.selected { 
        background-color: #0d6efd;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
    }
    .seat.sold { 
        background-color: #dc3545;
        cursor: not-allowed;
        opacity: 0.7;
    }
    .seat.bubilet {
        background-color: #198754; /* Green */
        cursor: not-allowed;
        opacity: 0.9;
    }
    .seat.biletinial {
        background-color: #ffc107; /* Yellow/Warning */
        cursor: not-allowed;
        opacity: 0.9;
    }
    .seat.decorative {
        background-color: #7c3aed; /* Purple - Kayƒ±t Dƒ±≈üƒ± */
        cursor: default;
        opacity: 0.85;
        pointer-events: none;
    }
    
    .seat-legend {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    
    /* Scrollable container for large seat layouts */
    #seating-area {
        max-width: 100%;
        max-height: 600px;
        overflow: auto;
        padding: 20px;
        width: fit-content;
        min-width: 100%;
        display: inline-flex !important;
        flex-direction: column;
        align-items: flex-start !important; /* Override align-items-center */
    }
    
    /* Parent container must allow overflow */
    .card-body {
        overflow-x: auto !important;
    }
    
    /* Bootstrap containers must not clip */
    .row {
        overflow-x: visible !important;
    }
    
    .col-lg-8 {
        overflow-x: visible !important;
    }
    
    /* Mobile responsiveness */
    @@media (max-width: 768px) {
        #seating-area {
            max-height: 500px;
            padding: 10px;
            width: max-content !important;
            min-width: unset !important;
        }
        .card-body {
            padding: 1rem !important;
            overflow-x: auto !important;
        }
        .seat {
            width: 28px !important;
            height: 28px !important;
            font-size: 0.65rem !important;
        }
        .seat-row {
            gap: 5px !important;
        }
    }

    /* Fullscreen Mode */
    .fullscreen-mode {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        background: #fff !important;
        margin: 0 !important;
        border-radius: 0 !important;
        overflow: auto !important;
    }
    
    .fullscreen-mode .card-header {
        position: sticky;
        top: 0;
        z-index: 10000;
        background: #fff !important;
    }
    
    .fullscreen-mode #seating-area {
        height: calc(100vh - 200px) !important;
        max-height: none !important;
    }
    
    .fullscreen-mode #seating-body {
        min-height: calc(100vh - 60px);
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        var selectedSeats = [];
        
        // REZERVASYON KODU ARAMA
        $('#rezervasyonAraBtn').click(function() {
            var kod = $('#rezervasyonKoduInput').val().trim().toUpperCase();
            
            if (!kod) {
                alert('L√ºtfen rezervasyon kodu girin.');
                return;
            }
            
            $.ajax({
                url: '/Admin/Satislar/RezervasyonBul',
                type: 'POST',
                data: { rezervasyonKodu: kod },
                success: function(response) {
                    if (response.success) {
                        var bilet = response.bilet;
                        $('#musteriAdSoyad').text(bilet.musteriAdi + ' ' + bilet.musteriSoyadi);
                        $('#musteriTel').text(bilet.musteriTelefon);
                        $('#kategoriAdi').text(bilet.kategoriAdi);
                        $('#biletFiyati').text(bilet.fiyat.toFixed(2));
                        $('#koltukAtamaLink').attr('href', '/Admin/Satislar/KoltukAtama?biletId=' + bilet.id);
                        
                        $('#biletBilgileri').show();
                        $('#rezervasyonSonuc').hide();
                    } else {
                        $('#biletBilgileri').hide();
                        $('#rezervasyonSonuc').html('<div class="alert alert-danger mb-0">' + response.message + '</div>').show();
                    }
                },
                error: function() {
                    $('#rezervasyonSonuc').html('<div class="alert alert-danger mb-0">Bir hata olu≈ütu.</div>').show();
                }
            });
        });
        
        // Enter tu≈üu ile arama
        $('#rezervasyonKoduInput').keypress(function(e) {
            if (e.which === 13) {
                e.preventDefault();
                $('#rezervasyonAraBtn').click();
            }
        });
        
        // Platform se√ßimi
        $('.platform-btn').click(function() {
            // T√ºm butonlardan active class'ƒ± kaldƒ±r
            $('.platform-btn').removeClass('btn-success btn-warning btn-secondary').addClass('btn-outline-secondary btn-outline-success btn-outline-warning');
            $('.platform-btn[data-platform="Archura"]').removeClass('btn-outline-secondary').addClass('btn-outline-secondary');
            $('.platform-btn[data-platform="Bubilet"]').removeClass('btn-outline-success').addClass('btn-outline-success');
            $('.platform-btn[data-platform="Biletinial"]').removeClass('btn-outline-warning').addClass('btn-outline-warning');
            
            // Se√ßilen butonu aktif yap
            var platform = $(this).data('platform');
            
            if (platform === 'Bubilet') {
                $(this).removeClass('btn-outline-success').addClass('btn-success');
                // Otomatik doldur
                $('input[name="musteriAdi"]').val('Bubilet Satƒ±≈üƒ±').prop('readonly', true);
                $('input[name="musteriSoyadi"]').val('Bubilet Satƒ±≈üƒ±').prop('readonly', true);
                $('input[name="musteriTelefon"]').val('-').prop('readonly', true);
                $('input[name="musteriEmail"]').val('bubilet@platform.com').prop('readonly', true);
            } else if (platform === 'Biletinial') {
                $(this).removeClass('btn-outline-warning').addClass('btn-warning');
                // Otomatik doldur
                $('input[name="musteriAdi"]').val('Biletinial Satƒ±≈üƒ±').prop('readonly', true);
                $('input[name="musteriSoyadi"]').val('Biletinial Satƒ±≈üƒ±').prop('readonly', true);
                $('input[name="musteriTelefon"]').val('-').prop('readonly', true);
                $('input[name="musteriEmail"]').val('biletinial@platform.com').prop('readonly', true);
            } else {
                $(this).removeClass('btn-outline-secondary').addClass('btn-secondary');
                // Alanlarƒ± temizle ve readonly'i kaldƒ±r
                $('input[name="musteriAdi"]').val('').prop('readonly', false);
                $('input[name="musteriSoyadi"]').val('').prop('readonly', false);
                $('input[name="musteriTelefon"]').val('').prop('readonly', false);
                $('input[name="musteriEmail"]').val('').prop('readonly', false);
            }
            
            // Hidden field'ƒ± g√ºncelle
            $('#selectedPlatform').val(platform);
        });
        
        // Sayfa y√ºklendiƒüinde Archura'yƒ± aktif yap
        $('.platform-btn[data-platform="Archura"]').click();
        
        // Koltuk planƒ± JSON'u
        var planJson = @Html.Raw(Model.Salon?.SeatingPlan?.PlanJson ?? "{}");
        var tickets = @Html.Raw(Json.Serialize(biletler?.Select(b => new { b.KoltukNo, b.DoluMu, b.SatisPlatformu })));

        var seatingArea = $('#seating-area');
        seatingArea.empty();

        if (!planJson.koltuklar || planJson.koltuklar.length === 0) {
            seatingArea.html('<p class="text-muted">Koltuk d√ºzeni bulunamadƒ±.</p>');
            return;
        }

    // --- Absolute Positioning Render Logic - SatisYap ---
    
    try {
        var SEAT_SIZE = 40; 
        
        // Backend'den gelen veri string ise parse et
        var rawPlan = @Html.Raw(Model.Salon?.SeatingPlan?.PlanJson ?? "{}");
        var planJson = typeof rawPlan === 'string' ? JSON.parse(rawPlan) : rawPlan;
        
        var rawTickets = @Html.Raw(Json.Serialize(biletler?.Select(b => new { b.KoltukNo, b.DoluMu, b.SatisPlatformu })));
        var tickets = rawTickets || [];

        var seatingArea = $('#seating-area');
        seatingArea.empty();
        
        // Container stilini relative ve responsive yap
        seatingArea.css({
            'position': 'relative',
            'width': '100%',
            'height': '600px',
            'overflow': 'auto',
            'background-color': '#e9ecef', 
            'border-radius': '8px',
            'padding': '0',
            'display': 'flex',
            'align-items': 'center',
            'justify-content': 'center'
        });

        if (!planJson || !planJson.koltuklar || planJson.koltuklar.length === 0) {
            seatingArea.html('<p class="text-muted p-4">Koltuk d√ºzeni bulunamadƒ±.</p>');
            // Don't return, let execution finish safely
        } else {

            // Canvas boyutunu hesapla
            let maxX = -Infinity;
            let maxY = -Infinity;
            let minX = Infinity;
            let minY = Infinity;

            planJson.koltuklar.forEach(s => {
                const x = parseFloat(s.x);
                const y = parseFloat(s.y);
                if (!isNaN(x)) {
                    if (x > maxX) maxX = x;
                    if (x < minX) minX = x;
                }
                if (!isNaN(y)) {
                    if (y > maxY) maxY = y;
                    if (y < minY) minY = y;
                }
            });

            // Sahne koordinatlarƒ±nƒ± hesapla
            if (planJson.sahne) {
                const sX = parseFloat(planJson.sahne.x);
                const sY = parseFloat(planJson.sahne.y);
                const sW = parseFloat(planJson.sahne.width);
                const sH = parseFloat(planJson.sahne.height);
                
                if (!isNaN(sX) && !isNaN(sY)) {
                    if (sX < minX) minX = sX;
                    if (sY < minY) minY = sY;
                    if (sX + sW > maxX) maxX = sX + sW;
                    if (sY + sH > maxY) maxY = sY + sH;
                }
            }

             // Eƒüer ge√ßerli koordinat yoksa varsayƒ±lan ata
            if (minX === Infinity) minX = 0;
            if (minY === Infinity) minY = 0;
            if (maxX === -Infinity) maxX = 800;
            if (maxY === -Infinity) maxY = 600;

            // Offset (Padding) ekle
            const PADDING = 50;
            const exactWidth = maxX - minX + SEAT_SIZE + (PADDING * 2);
            const exactHeight = maxY - minY + SEAT_SIZE + (PADDING * 2);
            
            // Scrollable Area Settings
            seatingArea.css({
                'position': 'relative',
                'width': '100%',
                'height': '600px', 
                'overflow': 'auto',
                'background-color': '#e9ecef', 
                'border-radius': '8px'
            });

            // Inner Canvas
            var canvas = $('<div>').css({
                'position': 'relative',
                'width': exactWidth + 'px',
                'height': exactHeight + 'px',
                'min-width': exactWidth + 'px',
                'flex-shrink': '0',
                'margin': 'auto'
            });
            seatingArea.append(canvas);

            // Render Loop
            planJson.koltuklar.forEach(function(seat) {
                var seatId = seat.blok + '-' + seat.sira + seat.numara;
                var ticket = tickets.find(t => t.koltukNo === seatId);
                var isSold = ticket && ticket.doluMu;
                var platform = ticket ? ticket.satisPlatformu : null;
                var isDecorative = seat.isDecorative === true;

                // X ve Y deƒüerlerini offsetle
                var seatX = parseFloat(seat.x);
                var seatY = parseFloat(seat.y);
                
                if (isNaN(seatX) || isNaN(seatY)) return; // Skip invalid coordinates

                var posX = seatX - minX + PADDING;
                var posY = seatY - minY + PADDING;

                var displayText = seat.sira + seat.numara;
                var fontSize = '0.7rem';
                if((displayText + "").length > 3) fontSize = '0.6rem';
                if((displayText + "").length > 4) fontSize = '0.5rem';

                var seatEl = $('<div>')
                    .addClass('seat')
                    .text(seat.numara) // Admin panelde sadece numara g√∂stermek yeterli olabilir, veya tam isim
                    .text(displayText)
                    .attr('data-seat', seatId)
                    .css({
                        'position': 'absolute',
                        'left': posX + 'px',
                        'top': posY + 'px',
                        'width': SEAT_SIZE + 'px',
                        'height': SEAT_SIZE + 'px',
                        'display': 'flex',
                        'align-items': 'center',
                        'justify-content': 'center',
                        'font-size': fontSize,
                        'line-height': '1',
                    });
                
                // Platform bazlƒ± renklendirme
                if (isDecorative) {
                    seatEl.addClass('decorative');
                    seatEl.attr('title', seat.sira + seat.numara + ' (Kayƒ±t Dƒ±≈üƒ±)');
                } else if (isSold) {
                    if (platform === 'Bubilet') {
                        seatEl.addClass('bubilet');
                        seatEl.attr('title', 'Koltuk: ' + seatId + ' - Bubilet');
                    } else if (platform === 'Biletinial') {
                        seatEl.addClass('biletinial');
                        seatEl.attr('title', 'Koltuk: ' + seatId + ' - Biletinial');
                    } else {
                        seatEl.addClass('sold');
                        seatEl.attr('title', 'Koltuk: ' + seatId + ' - Satƒ±lmƒ±≈ü');
                    }
                } else {
                    seatEl.addClass('empty');
                    seatEl.attr('title', 'Koltuk: ' + seatId);
                }
                
                // Tƒ±klama olayƒ±
                if (!isSold && !isDecorative) {
                    seatEl.click(function() {
                        var seatNo = $(this).attr('data-seat');
                        
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected').addClass('empty');
                            selectedSeats = selectedSeats.filter(s => s !== seatNo);
                        } else {
                            $(this).removeClass('empty').addClass('selected');
                            selectedSeats.push(seatNo);
                        }
                        
                        $('#selectedSeats').val(selectedSeats.join(', '));
                    });
                }
                
                canvas.append(seatEl);
            });

        }

    } catch (err) {
        console.error("Seating render error:", err);
        $('#seating-area').html('<div class="alert alert-danger m-3">Koltuk d√ºzeni y√ºklenirken hata olu≈ütu: ' + err.message + '</div>');
    }
    });
</script>

<script>
// Fullscreen Toggle Fonksiyonu
function toggleFullscreen() {
    var card = document.getElementById('seating-card');
    var btn = document.getElementById('fullscreenBtn');
    var icon = btn.querySelector('i');
    var text = btn.querySelector('span');
    
    card.classList.toggle('fullscreen-mode');
    
    if (card.classList.contains('fullscreen-mode')) {
        icon.classList.remove('fa-expand');
        icon.classList.add('fa-compress');
        text.textContent = 'K√º√ß√ºlt';
        document.body.style.overflow = 'hidden';
    } else {
        icon.classList.remove('fa-compress');
        icon.classList.add('fa-expand');
        text.textContent = 'Tam Ekran';
        document.body.style.overflow = '';
    }
}

// ESC tu≈üu ile √ßƒ±kƒ±≈ü
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var card = document.getElementById('seating-card');
        if (card && card.classList.contains('fullscreen-mode')) {
            toggleFullscreen();
        }
    }
});
</script>
