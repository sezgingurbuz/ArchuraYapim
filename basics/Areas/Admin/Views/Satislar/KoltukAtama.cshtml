@{
    ViewData["Title"] = "Koltuk Atama";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var kategoriBilet = ViewBag.KategoriBilet as basics.Areas.Admin.Models.KategoriBilet;
    var etkinlik = ViewBag.Etkinlik as basics.Areas.Admin.Models.Etkinlik;
    var biletler = ViewBag.Biletler as List<basics.Areas.Admin.Models.EtkinlikKoltuk>;
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fa-solid fa-chair me-2"></i>Koltuk Atama</h2>
            <p class="text-muted mb-0">@etkinlik?.EtkinlikAdi - @etkinlik?.Salon?.SalonAdi</p>
        </div>
        <a asp-action="SatisYap" asp-route-id="@etkinlik?.Id" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-2"></i>Geri Dön
        </a>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fa-solid fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- MÜŞTERİ BİLGİLERİ -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-success text-white py-3">
            <h5 class="m-0"><i class="fa-solid fa-ticket me-2"></i>Bilet Bilgileri</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="text-muted small">Rezervasyon Kodu</label>
                    <p class="fw-bold fs-5 text-primary">@kategoriBilet?.RezervasyonKodu</p>
                </div>
                <div class="col-md-3">
                    <label class="text-muted small">Müşteri</label>
                    <p class="fw-bold">@kategoriBilet?.MusteriAdi @kategoriBilet?.MusteriSoyadi</p>
                </div>
                <div class="col-md-2">
                    <label class="text-muted small">Telefon</label>
                    <p class="fw-bold">@kategoriBilet?.MusteriTelefon</p>
                </div>
                <div class="col-md-2">
                    <label class="text-muted small">Kategori</label>
                    <p class="fw-bold">@kategoriBilet?.EtkinlikKategori?.KategoriAdi</p>
                </div>
                <div class="col-md-2">
                    <label class="text-muted small">Ödenen Fiyat</label>
                    <p class="fw-bold text-success">@kategoriBilet?.OdenenFiyat.ToString("N2") ₺</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- KOLTUK DÜZENİ (SOL) -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="fa-solid fa-couch me-2"></i>Koltuk Seçimi</h5>
                    <span class="text-muted">Atamak istediğiniz koltuğa tıklayın</span>
                </div>
                <div class="card-body bg-light text-center p-4">
                    <div id="seating-area">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                    </div>

                    <div class="stage-mb-4 mx-auto bg-dark text-white rounded py-2 mb-4" style="max-width: 600px;">
                        SAHNE
                    </div>

                    <div class="d-flex justify-content-center gap-4 mt-4">
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-secondary me-2"></div> Boş
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-primary me-2"></div> Seçili
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-legend bg-danger me-2"></div> Dolu
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEÇİM PANELİ (SAĞ) -->
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="m-0"><i class="fa-solid fa-hand-pointer me-2"></i>Seçilen Koltuk</h5>
                </div>
                <div class="card-body text-center">
                    <div id="noSeatSelected">
                        <i class="fa-solid fa-arrow-left fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Soldan bir koltuk seçin</p>
                    </div>
                    
                    <div id="seatSelectedPanel" style="display: none;">
                        <div class="display-4 text-primary fw-bold mb-3" id="selectedSeatDisplay">-</div>
                        
                        <form asp-action="KoltukAtama" method="post" id="atamaForm">
                            <input type="hidden" name="biletId" value="@kategoriBilet?.Id" />
                            <input type="hidden" name="koltukNo" id="selectedKoltukNo" />
                            
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fa-solid fa-check me-2"></i>Koltuğu Ata
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .seat-row {
        gap: 8px;
    }
    .seat {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.2s;
        color: white;
        font-weight: 600;
    }
    .seat:hover:not(.sold) {
        transform: scale(1.15);
        z-index: 10;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .seat.empty { 
        background-color: #6c757d; 
    }
    .seat.selected { 
        background-color: #0d6efd;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.6);
        transform: scale(1.1);
    }
    .seat.sold { 
        background-color: #dc3545;
        cursor: not-allowed;
        opacity: 0.7;
    }
    .seat.decorative {
        background-color: #7c3aed;
        cursor: default;
        opacity: 0.85;
        pointer-events: none;
    }
    
    .seat-legend {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    
    #seating-area {
        max-width: 100%;
        max-height: 600px;
        overflow: auto;
        padding: 20px;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        var selectedSeat = null;
        var SEAT_SIZE = 40;
        
        try {
            var rawPlan = @Html.Raw(etkinlik?.Salon?.SeatingPlan?.PlanJson ?? "{}");
            var planJson = typeof rawPlan === 'string' ? JSON.parse(rawPlan) : rawPlan;
            
            var rawTickets = @Html.Raw(Json.Serialize(biletler?.Select(b => new { b.KoltukNo, b.DoluMu })));
            var tickets = rawTickets || [];

            var seatingArea = $('#seating-area');
            seatingArea.empty();
            
            seatingArea.css({
                'position': 'relative',
                'width': '100%',
                'height': '600px',
                'overflow': 'auto',
                'background-color': '#e9ecef', 
                'border-radius': '8px'
            });

            if (!planJson || !planJson.koltuklar || planJson.koltuklar.length === 0) {
                seatingArea.html('<p class="text-muted p-4">Koltuk düzeni bulunamadı.</p>');
            } else {
                // Canvas boyutunu hesapla
                let maxX = -Infinity, maxY = -Infinity, minX = Infinity, minY = Infinity;

                planJson.koltuklar.forEach(s => {
                    const x = parseFloat(s.x), y = parseFloat(s.y);
                    if (!isNaN(x)) { if (x > maxX) maxX = x; if (x < minX) minX = x; }
                    if (!isNaN(y)) { if (y > maxY) maxY = y; if (y < minY) minY = y; }
                });

                if (minX === Infinity) minX = 0;
                if (minY === Infinity) minY = 0;
                if (maxX === -Infinity) maxX = 800;
                if (maxY === -Infinity) maxY = 600;

                const PADDING = 50;
                const exactWidth = maxX - minX + SEAT_SIZE + (PADDING * 2);
                const exactHeight = maxY - minY + SEAT_SIZE + (PADDING * 2);

                var canvas = $('<div>').css({
                    'position': 'relative',
                    'width': exactWidth + 'px',
                    'height': exactHeight + 'px',
                    'min-width': exactWidth + 'px',
                    'flex-shrink': '0',
                    'margin': 'auto'
                });
                seatingArea.append(canvas);

                planJson.koltuklar.forEach(function(seat) {
                    var seatId = seat.blok + '-' + seat.sira + seat.numara;
                    var ticket = tickets.find(t => t.koltukNo === seatId);
                    var isSold = ticket && ticket.doluMu;
                    var isDecorative = seat.isDecorative === true;

                    var seatX = parseFloat(seat.x), seatY = parseFloat(seat.y);
                    if (isNaN(seatX) || isNaN(seatY)) return;

                    var posX = seatX - minX + PADDING;
                    var posY = seatY - minY + PADDING;

                    var displayText = seat.sira + seat.numara;

                    var seatEl = $('<div>')
                        .addClass('seat')
                        .text(displayText)
                        .attr('data-seat', seatId)
                        .css({
                            'position': 'absolute',
                            'left': posX + 'px',
                            'top': posY + 'px',
                            'width': SEAT_SIZE + 'px',
                            'height': SEAT_SIZE + 'px'
                        });
                    
                    if (isDecorative) {
                        seatEl.addClass('decorative');
                    } else if (isSold) {
                        seatEl.addClass('sold');
                        seatEl.attr('title', 'Dolu: ' + seatId);
                    } else {
                        seatEl.addClass('empty');
                        seatEl.attr('title', 'Koltuk: ' + seatId);
                        
                        // Tıklama olayı - tek seçim
                        seatEl.click(function() {
                            var seatNo = $(this).attr('data-seat');
                            
                            // Önceki seçimi kaldır
                            $('.seat.selected').removeClass('selected').addClass('empty');
                            
                            // Yeni seçimi yap
                            $(this).removeClass('empty').addClass('selected');
                            selectedSeat = seatNo;
                            
                            // Paneli güncelle
                            $('#noSeatSelected').hide();
                            $('#seatSelectedPanel').show();
                            $('#selectedSeatDisplay').text(seatNo);
                            $('#selectedKoltukNo').val(seatNo);
                        });
                    }
                    
                    canvas.append(seatEl);
                });
            }

        } catch (err) {
            console.error("Seating render error:", err);
            $('#seating-area').html('<div class="alert alert-danger m-3">Koltuk düzeni yüklenirken hata oluştu: ' + err.message + '</div>');
        }
    });
</script>
