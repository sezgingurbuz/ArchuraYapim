@model List<basics.Areas.Admin.Models.RaporViewModel>

@{
    ViewData["Title"] = "Etkinlik Raporları";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    @@media print {
        /* Yazdırırken menüleri ve butonları gizle */
        .sidebar, header, .btn-print, .no-print {
            display: none !important;
        }
        /* İçeriği tam sayfa yap */
        .content, .container-fluid {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        /* Arka plan renklerini koru */
        -webkit-print-color-adjust: exact;
    }

    .report-card {
        border-left: 5px solid #4e54c8; /* Sol taraf mor çizgi */
        transition: transform 0.2s;
    }
    .report-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
</style>

<div class="container-fluid p-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h2 class="fw-bold text-dark m-0">Tamamlanan Etkinlik Raporları</h2>
            <p class="text-muted small m-0">Geçmiş etkinliklerin hasılat ve doluluk oranları.</p>
        </div>
        <button onclick="window.print()" class="btn btn-outline-dark btn-print">
            <i class="fa-solid fa-print me-2"></i>Sayfayı Yazdır
        </button>
    </div>

    <!-- FİLTRELEME ALANI -->
    <div class="card border-0 shadow-sm mb-4 no-print">
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="m-0 text-muted"><i class="fa-solid fa-filter me-2"></i>Filtreleme</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                    <i class="fa-solid fa-rotate-right me-1"></i>Temizle
                </button>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="filterName" class="form-control form-control-sm" placeholder="Etkinlik Adı..." onkeyup="applyFilters()">
                </div>
                <div class="col-md-3">
                    <input type="date" id="filterDate" class="form-control form-control-sm" onchange="applyFilters()">
                </div>
                <div class="col-md-3">
                    <input type="text" id="filterSalon" class="form-control form-control-sm" placeholder="Salon..." onkeyup="applyFilters()">
                </div>
                <div class="col-md-3">
                    <input type="text" id="filterSehir" class="form-control form-control-sm" placeholder="Şehir..." onkeyup="applyFilters()">
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fa-solid fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.Count == 0)
    {
        <div class="alert alert-warning text-center">
            Henüz tamamlanmış (tarihi geçmiş) bir etkinlik bulunmamaktadır.
        </div>
    }
    else
    {
        <div class="row g-4" id="reportsContainer">
            @foreach (var rapor in Model)
            {
                <div class="col-12 col-xl-6 report-item" 
                     data-name="@rapor.EtkinlikAdi" 
                     data-date="@rapor.Tarih.ToString("yyyy-MM-dd")" 
                     data-salon="@rapor.SalonAdi" 
                     data-sehir="@rapor.Sehir">
                    <div class="card shadow-sm border-0 report-card h-100">
                        <div class="card-body p-4">
                            
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h4 class="fw-bold text-primary mb-1">@rapor.EtkinlikAdi</h4>
                                    <span class="text-muted small">
                                        <i class="fa-solid fa-location-dot me-1"></i> @rapor.SalonAdi, @rapor.Sehir
                                    </span>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-dark">@rapor.Tarih.ToString("dd MMMM yyyy")</div>
                                    <div class="text-muted small">@rapor.Tarih.ToString("HH:mm")</div>
                                </div>
                            </div>

                            <hr class="text-muted opacity-25">

                            <div class="row text-center mt-4">
                                <div class="col-4 border-end">
                                    <div class="text-muted small fw-bold text-uppercase">Satılan</div>
                                    <div class="fs-4 fw-bold text-success">@rapor.SatilanBilet</div>
                                    <div class="small text-muted">Adet</div>
                                </div>
                                <div class="col-4 border-end">
                                    <div class="text-muted small fw-bold text-uppercase">Boş</div>
                                    <div class="fs-4 fw-bold text-secondary">@rapor.BosKoltuk</div>
                                    <div class="small text-muted">Adet</div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted small fw-bold text-uppercase">Hasılat</div>
                                    <div class="fs-4 fw-bold text-primary">@rapor.ToplamHasilat.ToString("C0")</div>
                                    <div class="small text-muted">TL</div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small fw-bold text-muted">Doluluk Oranı</span>
                                    <span class="small fw-bold text-dark">%@rapor.DolulukOrani</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: @rapor.DolulukOrani%" 
                                         aria-valuenow="@rapor.DolulukOrani" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>

                            <hr class="text-muted opacity-25 mt-4">

                            <!-- PLATFORM BAZLI SATIŞLAR -->
                            <div class="mt-3">
                                <h6 class="fw-bold text-muted small mb-3"><i class="fa-solid fa-ticket me-2"></i>PLATFORM SATIŞLARI</h6>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <div class="text-success fw-bold fs-5">@rapor.BubiletSatisAdedi</div>
                                            <div class="small text-muted">Bubilet</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <div class="text-warning fw-bold fs-5">@rapor.BiletinialSatisAdedi</div>
                                            <div class="small text-muted">Biletinial</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="text-muted opacity-25 mt-4">

                            <!-- ÖDEME YÖNTEMİ BAZLI İSTATİSTİKLER -->
                            <div class="mt-3">
                                <h6 class="fw-bold text-muted small mb-3"><i class="fa-solid fa-credit-card me-2"></i>ÖDEME YÖNTEMLERİ</h6>
                                
                                <div class="mb-2 p-2 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-success">Nakit</span>
                                            <span class="ms-2 small text-muted">@rapor.NakitSatisAdedi Koltuk</span>
                                        </div>
                                        <div class="fw-bold text-success">@rapor.NakitHasilat.ToString("C0")</div>
                                    </div>
                                </div>

                                <div class="mb-2 p-2 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-primary">Kart</span>
                                            <span class="ms-2 small text-muted">@rapor.KartSatisAdedi Koltuk</span>
                                        </div>
                                        <div class="fw-bold text-primary">@rapor.KartHasilat.ToString("C0")</div>
                                    </div>
                                </div>

                                <div class="p-2 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-info">EFT</span>
                                            <span class="ms-2 small text-muted">@rapor.EFTSatisAdedi Koltuk</span>
                                        </div>
                                        <div class="fw-bold text-info">@rapor.EFTHasilat.ToString("C0")</div>
                                    </div>
                                </div>
                            </div>

                            <!-- SİL BUTONU -->
                            <div class="mt-4 pt-3 border-top no-print">
                                <form asp-action="Sil" asp-route-id="@rapor.EtkinlikId" method="post" class="d-inline" onsubmit="return confirmDelete('@rapor.EtkinlikAdi', '@rapor.Tarih.ToString("dd.MM.yyyy")')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="fa-solid fa-trash me-2"></i>Raporu Sil
                                    </button>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<script>
    // Filtreleme fonksiyonu
    function applyFilters() {
        const filterName = document.getElementById('filterName').value.toUpperCase();
        const filterDate = document.getElementById('filterDate').value;
        const filterSalon = document.getElementById('filterSalon').value.toUpperCase();
        const filterSehir = document.getElementById('filterSehir').value.toUpperCase();
        
        const reportItems = document.querySelectorAll('.report-item');
        
        reportItems.forEach(item => {
            const name = item.getAttribute('data-name').toUpperCase();
            const date = item.getAttribute('data-date');
            const salon = item.getAttribute('data-salon').toUpperCase();
            const sehir = item.getAttribute('data-sehir').toUpperCase();
            
            const matchName = name.includes(filterName);
            const matchDate = !filterDate || date === filterDate;
            const matchSalon = salon.includes(filterSalon);
            const matchSehir = sehir.includes(filterSehir);
            
            if (matchName && matchDate && matchSalon && matchSehir) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Filtreleri temizle
    function resetFilters() {
        document.getElementById('filterName').value = '';
        document.getElementById('filterDate').value = '';
        document.getElementById('filterSalon').value = '';
        document.getElementById('filterSehir').value = '';
        applyFilters();
    }
    
    // Silme onayı
    function confirmDelete(etkinlikAdi, tarih) {
        return confirm('⚠️ UYARI!\n\nBu raporu silmek istediğinize emin misiniz?\n\nEtkinlik: ' + etkinlikAdi + '\nTarih: ' + tarih + '\n\nBu işlem GERİ ALINAMAZ!');
    }
</script>