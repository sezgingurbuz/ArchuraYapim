@using basics.Models
@model List<BiletGrubu>
@{
    ViewData["Title"] = "Biletlerim";
    Layout = "_Layout";
    var kategoriBiletler = ViewBag.KategoriBiletler as List<basics.Areas.Admin.Models.KategoriBilet>;
}

<link rel="stylesheet" href="~/css/bilet-style.css" />

<div class="biletlerim-page">
    <div class="container py-4">
        <div class="page-header">
            <h1><i class="fas fa-ticket-alt"></i> Biletlerim</h1>
            <p>Satın aldığınız tüm biletler burada listelenir.</p>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <span>@TempData["SuccessMessage"]</span>
            </div>
        }

        @if (TempData["RezervasyonKodlari"] != null)
        {
            var kodlar = TempData["RezervasyonKodlari"] as List<string>;
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle me-2"></i>Rezervasyon Kodlarınız</h5>
                <p class="mb-2">Aşağıdaki kodları gişede göstererek koltuk seçiminizi tamamlayabilirsiniz:</p>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var kod in kodlar ?? new List<string>())
                    {
                        <span class="badge bg-primary fs-5 p-2">@kod</span>
                    }
                </div>
            </div>
        }

        @* KATEGORİ BİLETLERİ *@
        @if (kategoriBiletler != null && kategoriBiletler.Any())
        {
            <div class="mb-4">
                <h4 class="mb-3"><i class="fas fa-tags me-2"></i>Kategori Biletleri</h4>
                <div class="tickets-grid">
                    @foreach (var bilet in kategoriBiletler)
                    {
                        var isPast = bilet.EtkinlikKategori?.Etkinlik?.TarihSaat < DateTime.Now;
                        <div class="ticket-card @(isPast ? "past-event" : "") @(bilet.KoltukAtandiMi ? "" : "pending")">
                            <div class="ticket-header">
                                <div class="event-name">@bilet.EtkinlikKategori?.Etkinlik?.EtkinlikAdi</div>
                                @if (bilet.KoltukAtandiMi)
                                {
                                    <span class="badge badge-upcoming"><i class="fas fa-check"></i> Koltuk Atandı</span>
                                }
                                else
                                {
                                    <span class="badge" style="background: #f7931e;"><i class="fas fa-clock"></i> Koltuk Bekleniyor</span>
                                }
                            </div>
                            
                            <div class="ticket-body">
                                <div class="ticket-info">
                                    <div class="info-item" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                                        <strong>Rezervasyon Kodu:</strong>
                                        <span class="fs-5">@bilet.RezervasyonKodu</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-layer-group"></i>
                                        <span>Kategori: <strong>@bilet.EtkinlikKategori?.KategoriAdi</strong></span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>@bilet.EtkinlikKategori?.Etkinlik?.TarihSaat.ToString("dd MMMM yyyy, HH:mm")</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>@bilet.EtkinlikKategori?.Etkinlik?.Salon?.SalonAdi, @bilet.EtkinlikKategori?.Etkinlik?.Salon?.Sehir</span>
                                    </div>
                                </div>

                                @if (bilet.KoltukAtandiMi && bilet.AtananKoltuk != null)
                                {
                                    <div class="ticket-seat">
                                        <div class="seat-label">Atanan Koltuk</div>
                                        <div class="seat-numbers">@bilet.AtananKoltuk.KoltukNo</div>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-0 mt-2" style="font-size: 0.85rem;">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Gişeye giderek rezervasyon kodunuzu gösterin ve koltuk seçiminizi yapın.
                                    </div>
                                }
                            </div>

                            <div class="ticket-footer">
                                <div class="purchase-date">
                                    <i class="fas fa-shopping-cart"></i>
                                    @bilet.SatisTarihi.ToString("dd.MM.yyyy HH:mm")
                                </div>
                                <div class="ticket-price">
                                    ₺@bilet.OdenenFiyat.ToString("N2")
                                </div>
                            </div>
                            
                            @if (bilet.KoltukAtandiMi)
                            {
                                <div style="padding: 15px; border-top: 1px solid var(--border-color);">
                                    <a asp-action="KategoriBiletDetay" asp-route-biletId="@bilet.Id" class="btn-qr-view">
                                        <i class="fas fa-qrcode"></i> QR Kodu Göster
                                    </a>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @* KOLTUK BİLETLERİ *@
        @if (Model != null && Model.Any())
        {
            <div class="mb-4">
                @if (kategoriBiletler != null && kategoriBiletler.Any())
                {
                    <h4 class="mb-3"><i class="fas fa-couch me-2"></i>Koltuk Biletleri</h4>
                }
                <div class="tickets-grid">
                    @foreach (var grup in Model)
                    {
                        var isPast = grup.Etkinlik?.TarihSaat < DateTime.Now;
                        <div class="ticket-card @(isPast ? "past-event" : "")">
                            <div class="ticket-header">
                                <div class="event-name">@grup.Etkinlik?.EtkinlikAdi</div>
                                @if (isPast)
                                {
                                    <span class="badge badge-past">Geçmiş Etkinlik</span>
                                }
                                else
                                {
                                    <span class="badge badge-upcoming">Yaklaşan</span>
                                }
                            </div>
                            
                            <div class="ticket-body">
                                <div class="ticket-info">
                                    <div class="info-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>@grup.Etkinlik?.TarihSaat.ToString("dd MMMM yyyy, dddd")</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-clock"></i>
                                        <span>@grup.Etkinlik?.TarihSaat.ToString("HH:mm")</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>@grup.Etkinlik?.Salon?.SalonAdi, @grup.Etkinlik?.Salon?.Sehir</span>
                                    </div>
                                </div>

                                <div class="ticket-seat">
                                    <div class="seat-label">@grup.BiletSayisi Koltuk</div>
                                    <div class="seat-numbers">@grup.Koltuklar</div>
                                </div>
                            </div>

                            <div class="ticket-footer">
                                <div class="purchase-date">
                                    <i class="fas fa-shopping-cart"></i>
                                    @grup.SatisTarihi?.ToString("dd.MM.yyyy HH:mm")
                                </div>
                                <div class="ticket-price">
                                    ₺@grup.ToplamFiyat.ToString("N2")
                                </div>
                            </div>
                            
                            <div style="padding: 15px; border-top: 1px solid var(--border-color);">
                                <a asp-action="BiletGrubuDetay" 
                                   asp-route-etkinlikId="@grup.Etkinlik?.Id"
                                   asp-route-satisTarihi="@grup.SatisTarihi?.ToString("yyyyMMddHHmmss")"
                                   class="btn-qr-view">
                                    <i class="fas fa-qrcode"></i> QR Kodları Göster
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        
        @* HİÇ BİLET YOKSA *@
        @if ((Model == null || !Model.Any()) && (kategoriBiletler == null || !kategoriBiletler.Any()))
        {
            <div class="no-tickets">
                <i class="fas fa-ticket-alt"></i>
                <h3>Henüz biletiniz yok</h3>
                <p>Etkinliklere göz atarak ilk biletinizi satın alabilirsiniz.</p>
                <a asp-action="Index" class="btn-browse">
                    <i class="fas fa-search"></i>
                    Etkinliklere Göz At
                </a>
            </div>
        }
    </div>
</div>

<style>
    .ticket-card.pending {
        border-left: 4px solid #f7931e;
    }
</style>
