@model basics.Areas.Admin.Models.Etkinlik
@{
    ViewData["Title"] = "Bilet Al - " + Model.EtkinlikAdi;
    Layout = "_Layout";
    var biletler = ViewBag.Biletler as List<basics.Areas.Admin.Models.EtkinlikKoltuk>;
    var kategoriler = ViewBag.Kategoriler as List<basics.Areas.Admin.Models.EtkinlikKategori>;
    var kategoriSatisSayilari = ViewBag.KategoriSatisSayilari as Dictionary<int, int>;
    var satisTipi = ViewBag.SatisTipi as string ?? "Koltuk";
    var biletFiyati = ViewBag.BiletFiyati as decimal? ?? 150m;
}

<link rel="stylesheet" href="~/css/bilet-style.css?v=3" />

<div class="bilet-page-new">
    <!-- Header: Etkinlik Bilgileri -->
    <div class="bilet-header-bar">
        <div class="header-left">
            <div class="event-poster">
                <div class="poster-placeholder">
                    <i class="fas fa-theater-masks"></i>
                </div>
            </div>
            <div class="event-info-compact">
                <h1>@Model.EtkinlikAdi</h1>
                <div class="event-meta">
                    <span><i class="fas fa-map-marker-alt"></i> @Model.Salon?.SalonAdi, @Model.Salon?.Sehir</span>
                    <span><i class="fas fa-calendar-alt"></i> @Model.TarihSaat.ToString("dd MMMM yyyy, dddd")</span>
                    <span><i class="fas fa-clock"></i> @Model.TarihSaat.ToString("HH:mm")</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <a asp-action="Index" class="btn-back-small">
                <i class="fas fa-arrow-left"></i>
                <span>Geri</span>
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    }

    <!-- Main Content -->
    <div class="bilet-main-content">
        
        @if (satisTipi == "Kategori")
        {
            <!-- KATEGORİ SATIŞI -->
            <style>
                .kategori-overlay {
                    position: relative;
                    width: 100%;
                }
                .blurred-seats {
                    filter: blur(8px);
                    opacity: 0.4;
                    pointer-events: none;
                    user-select: none;
                }
                .kategori-cards-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 10;
                    padding: 2rem;
                }
                .kategori-warning {
                    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 12px;
                    margin-bottom: 2rem;
                    text-align: center;
                    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
                    max-width: 600px;
                }
                .kategori-warning i {
                    font-size: 1.5rem;
                    margin-right: 0.5rem;
                }
                .kategori-cards {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1.5rem;
                    justify-content: center;
                    max-width: 900px;
                }
                .kategori-card {
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
                    padding: 1.5rem;
                    min-width: 220px;
                    text-align: center;
                    transition: transform 0.3s, box-shadow 0.3s;
                    cursor: pointer;
                    border: 3px solid transparent;
                }
                .kategori-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 12px 40px rgba(0,0,0,0.2);
                    border-color: #28a745;
                }
                .kategori-card.tukendi {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                .kategori-card.tukendi:hover {
                    transform: none;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
                    border-color: transparent;
                }
                .kategori-name {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: #1a1a2e;
                    margin-bottom: 0.5rem;
                }
                .kategori-price {
                    font-size: 1.8rem;
                    font-weight: 800;
                    color: #28a745;
                    margin-bottom: 0.5rem;
                }
                .kategori-kontenjan {
                    font-size: 0.85rem;
                    color: #6c757d;
                    margin-bottom: 1rem;
                }
                .kategori-btn {
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    border-radius: 25px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    width: 100%;
                    text-decoration: none;
                    display: block;
                }
                .kategori-btn:hover {
                    background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
                    transform: scale(1.05);
                    color: white;
                }
                .kategori-btn.disabled {
                    background: #ccc;
                    cursor: not-allowed;
                }
            </style>
            
            <div class="kategori-overlay">
                <!-- Blur'lu koltuk düzeni arka planda -->
                <div class="seating-wrapper blurred-seats">
                    <div id="seating-area" class="seating-area-fullscreen">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Koltuklar yükleniyor...</span>
                        </div>
                    </div>
                    <div class="stage-bottom">SAHNE</div>
                </div>
                
                <!-- Kategori kartları overlay -->
                <div class="kategori-cards-container">
                    <div class="kategori-warning">
                        <i class="fas fa-info-circle"></i>
                        <strong>Koltuk seçimi gişede yapılacaktır.</strong>
                        <p class="mb-0 mt-2" style="font-size: 0.9rem;">
                            Online satın aldığınız biletinizi gişede göstererek koltuk seçiminizi tamamlayabilirsiniz.
                        </p>
                    </div>
                    
                    <div class="kategori-cards">
                        @if (kategoriler != null && kategoriler.Any())
                        {
                            @foreach (var kat in kategoriler)
                            {
                                var satilanAdet = kategoriSatisSayilari?.ContainsKey(kat.Id) == true ? kategoriSatisSayilari[kat.Id] : 0;
                                var kalanKontenjan = kat.Kontenjan.HasValue ? kat.Kontenjan.Value - satilanAdet : (int?)null;
                                var tukendi = kalanKontenjan.HasValue && kalanKontenjan <= 0;
                                
                                <div class="kategori-card @(tukendi ? "tukendi" : "")">
                                    <div class="kategori-name">@kat.KategoriAdi</div>
                                    <div class="kategori-price">@kat.Fiyat.ToString("N2") ₺</div>
                                    @if (kat.Kontenjan.HasValue)
                                    {
                                        <div class="kategori-kontenjan">
                                            @if (tukendi)
                                            {
                                                <span class="text-danger"><i class="fas fa-times-circle"></i> Tükendi</span>
                                            }
                                            else
                                            {
                                                <span>Kalan: @kalanKontenjan bilet</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="kategori-kontenjan">Sınırsız kontenjan</div>
                                    }
                                    
                                    @if (!tukendi)
                                    {
                                        <a asp-action="KategoriOdeme" asp-route-kategoriId="@kat.Id" asp-route-adet="1" class="kategori-btn">
                                            <i class="fas fa-shopping-cart me-2"></i>Satın Al
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="kategori-btn disabled" disabled>Tükendi</button>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-white">
                                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                                <p>Bu etkinlik için henüz kategori tanımlanmamış.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- KOLTUK SATIŞI (Mevcut davranış) -->
            <!-- Legend Bar -->
            <div class="legend-bar">
                <div class="legend-item">
                    <div class="legend-box selected"></div>
                    <span>Seçilen</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box sold"></div>
                    <span>Dolu</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box empty"></div>
                    <span>Boş</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box decorative"></div>
                    <span>Kayıt Dışı</span>
                </div>
            </div>

            <!-- Floating Price Card -->
            <div class="price-card-floating">
                <div class="price-card-header">
                    <i class="fas fa-clock"></i>
                    <span>BİLET FİYATLARI</span>
                </div>
                <div class="price-card-body">
                    <div class="price-list">
                        <div class="price-item">
                            <span class="price-amount">@biletFiyati.ToString("N2") ₺</span>
                            <span class="price-type">Tam</span>
                        </div>
                    </div>
                    
                    <!-- Koltuk seçilmeden önce -->
                    <div id="noSeatSelected" class="no-seat-state">
                        <button type="button" class="btn-select-seat">KOLTUK SEÇİNİZ</button>
                    </div>

                    <!-- Koltuk seçildikten sonra -->
                    <div id="seatSelectedState" class="seat-selected-state" style="display: none;">
                        <div class="selected-seats-list">
                            <label>Seçilen Koltuklar:</label>
                            <div id="selectedSeatsList" class="seats-tags"></div>
                        </div>
                        <div class="total-section">
                            <div class="total-row">
                                <span class="total-label">Toplam (<span id="seatCountDisplay">0</span> bilet)</span>
                                <span id="totalPriceDisplay" class="total-amount">0,00 ₺</span>
                            </div>
                        </div>
                        <form asp-action="OdemeYap" method="get" id="paymentForm">
                            <input type="hidden" name="etkinlikId" value="@Model.Id" />
                            <input type="hidden" name="koltuklar" id="selectedSeatsInput" />
                            <input type="hidden" name="toplamFiyat" id="totalPriceInput" />
                            <button type="submit" class="btn-payment">
                                <i class="fas fa-credit-card"></i>
                                <span>Ödeme Yap</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Seating Area - Full Screen -->
            <div class="seating-wrapper">
                <div id="seating-area" class="seating-area-fullscreen">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Koltuklar yükleniyor...</span>
                    </div>
                </div>
                <div class="stage-bottom">SAHNE</div>
            </div>
        }
    </div>
</div>

<!-- Login Popup Modal -->
@if (!User.IsInRole("Customer"))
{
<div id="loginPopup" class="login-popup-overlay" style="display: none;">
    <div class="login-popup-modal">
        <button type="button" class="popup-close" onclick="hideLoginPopup()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="popup-header">
            <i class="fas fa-user-circle"></i>
            <h3>Giriş Yap</h3>
        </div>
        
        <div class="popup-body">
            <form id="popupLoginForm" method="post">
                <div class="popup-form-group">
                    <label>E-posta</label>
                    <input type="email" id="popupEmail" name="email" class="popup-input" 
                           placeholder="ornek@email.com" required />
                </div>
                
                <div class="popup-form-group">
                    <label>Şifre</label>
                    <input type="password" id="popupPassword" name="password" class="popup-input" 
                           placeholder="••••••" required />
                </div>
                
                <div id="popupError" class="popup-error" style="display: none;"></div>
                
                <div class="popup-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Giriş yapmadan devam ederseniz biletlerinizi sitemiz üzerinden görüntüleyemeyeceksiniz.</span>
                </div>
                
                <a href="javascript:void(0)" class="guest-continue-link" onclick="hideLoginPopup()">
                    <i class="fas fa-arrow-right"></i> Üyeliksiz devam et
                </a>
                
                <button type="submit" class="popup-login-btn">
                    <i class="fas fa-sign-in-alt"></i> Giriş Yap
                </button>
            </form>
            
            <div class="popup-register">
                <p>Hesabınız yok mu?</p>
                <a asp-controller="Account" asp-action="Register" asp-route-returnUrl="@Context.Request.Path">
                    Hemen kayıt olun
                </a>
            </div>
        </div>
    </div>
</div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        var selectedSeats = [];
        var ticketPrice = @biletFiyati;
        
        // Giriş yapmamış kullanıcı için popup'ı otomatik aç
        @if (!User.IsInRole("Customer"))
        {
            <text>
            showLoginPopup();
            </text>
        }
        
        function updateUI() {
            var count = selectedSeats.length;
            var total = count * ticketPrice;
            
            if (count > 0) {
                $('#noSeatSelected').hide();
                $('#seatSelectedState').show();
                
                // Seçilen koltukları listele
                var seatsTags = '';
                selectedSeats.forEach(function(seat) {
                    seatsTags += '<span class="seat-tag">' + seat + '</span>';
                });
                $('#selectedSeatsList').html(seatsTags);
                
                $('#seatCountDisplay').text(count);
                $('#totalPriceDisplay').text(total.toFixed(2).replace('.', ',') + ' ₺');
                $('#selectedSeatsInput').val(selectedSeats.join(','));
                $('#totalPriceInput').val(total);
            } else {
                $('#noSeatSelected').show();
                $('#seatSelectedState').hide();
            }
        }
        
        // --- Absolute Positioning Render Logic ---
        try {
            var SEAT_SIZE = 40; 
            
            // Backend'den gelen veri string ise parse et
            var rawPlan = @Html.Raw(Model.Salon?.SeatingPlan?.PlanJson ?? "{}");
            var planJson = typeof rawPlan === 'string' ? JSON.parse(rawPlan) : rawPlan;
            
            var rawTickets = @Html.Raw(Json.Serialize(biletler?.Select(b => new { b.KoltukNo, b.DoluMu })));
            var tickets = rawTickets || [];

            var seatingArea = $('#seating-area');
            seatingArea.empty();
            
            if (!planJson || !planJson.koltuklar || planJson.koltuklar.length === 0) {
                seatingArea.html('<p class="no-seats">Koltuk düzeni bulunamadı.</p>');
                return;
            } else {
                // Canvas boyutunu hesapla
                let maxX = -Infinity;
                let maxY = -Infinity;
                let minX = Infinity;
                let minY = Infinity;

                // Koordinatları güvenli şekilde hesapla
                planJson.koltuklar.forEach(s => {
                    const x = parseFloat(s.x);
                    const y = parseFloat(s.y);
                    if (!isNaN(x)) {
                        if (x > maxX) maxX = x;
                        if (x < minX) minX = x;
                    }
                    if (!isNaN(y)) {
                        if (y > maxY) maxY = y;
                        if (y < minY) minY = y;
                    }
                });

                // Sahne koordinatlarını da hesaba kat
                if (planJson.sahne) {
                    const sX = parseFloat(planJson.sahne.x);
                    const sY = parseFloat(planJson.sahne.y);
                    const sW = parseFloat(planJson.sahne.width);
                    const sH = parseFloat(planJson.sahne.height);
                    
                    if (!isNaN(sX) && !isNaN(sY)) {
                        if (sX < minX) minX = sX;
                        if (sY < minY) minY = sY;
                        if (sX + sW > maxX) maxX = sX + sW;
                        if (sY + sH > maxY) maxY = sY + sH;
                    }
                }

                // Eğer geçerli koordinat yoksa varsayılan ata
                if (minX === Infinity) minX = 0;
                if (minY === Infinity) minY = 0;
                if (maxX === -Infinity) maxX = 800;
                if (maxY === -Infinity) maxY = 600;

                // Offset (Padding) ekle
                const PADDING = 50;
                const exactWidth = maxX - minX + SEAT_SIZE + (PADDING * 2);
                const exactHeight = maxY - minY + SEAT_SIZE + (PADDING * 2);
                
                // Scrollable Area Settings
                seatingArea.css({
                    'position': 'relative',
                    'width': '100%',
                    'min-height': '500px',
                    'height': 'auto',
                    'overflow': 'auto',
                    'background-color': '#111827',
                    'border-radius': '8px',
                    'display': 'flex',
                    'align-items': 'center',
                    'justify-content': 'center'
                });

                // Inner Canvas
                var canvas = $('<div>').css({
                    'position': 'relative',
                    'width': exactWidth + 'px',
                    'height': exactHeight + 'px',
                    'min-width': exactWidth + 'px',
                    'margin': 'auto'
                });
                seatingArea.append(canvas);

                // Render Loop
                planJson.koltuklar.forEach(function(seat) {
                    var seatId = seat.blok + '-' + seat.sira + seat.numara;
                    var ticket = tickets.find(t => t.koltukNo === seatId);
                    var isSold = ticket && ticket.doluMu;
                    var isDecorative = seat.isDecorative === true;

                    // X ve Y değerlerini offsetle
                    var seatX = parseFloat(seat.x);
                    var seatY = parseFloat(seat.y);
                    
                    // Eğer koordinat yoksa (eski veri), pas geç veya varsayılan yerleştir
                    if (isNaN(seatX) || isNaN(seatY)) return;

                    var posX = seatX - minX + PADDING;
                    var posY = seatY - minY + PADDING;

                    var displayText = seat.sira + seat.numara;
                    var fontSize = '0.7rem';
                    if((displayText + "").length > 3) fontSize = '0.6rem';
                    if((displayText + "").length > 4) fontSize = '0.5rem';

                    var seatEl = $('<div>')
                        .addClass('seat')
                        .text(displayText)
                        .attr('data-seat', seatId)
                        .attr('title', isDecorative ? seat.sira + seat.numara + ' (Kayıt Dışı)' : 'Koltuk: ' + seatId)
                        .css({
                            'position': 'absolute',
                            'left': posX + 'px',
                            'top': posY + 'px',
                            'width': SEAT_SIZE + 'px',
                            'height': SEAT_SIZE + 'px',
                            'display': 'flex',
                            'align-items': 'center',
                            'justify-content': 'center',
                            'font-size': fontSize,
                            'line-height': '1'
                        });
                    
                    if (isDecorative) {
                        seatEl.addClass('decorative');
                    } else if (isSold) {
                        seatEl.addClass('sold');
                    } else {
                        seatEl.addClass('empty');
                        seatEl.click(function() {
                            var seatNo = $(this).attr('data-seat');
                            
                            if ($(this).hasClass('selected')) {
                                $(this).removeClass('selected').addClass('empty');
                                selectedSeats = selectedSeats.filter(s => s !== seatNo);
                            } else {
                                $(this).removeClass('empty').addClass('selected');
                                selectedSeats.push(seatNo);
                            }
                            
                            updateUI();
                        });
                    }
                    
                    canvas.append(seatEl);
                });

            }
        } catch (err) {
            console.error("Seating render error:", err);
            $('#seating-area').html('<div class="alert alert-danger">Koltuk düzeni yüklenirken hata oluştu: ' + err.message + '</div>');
        }
    });

    // Login Popup Functions
    function showLoginPopup() {
        $('#loginPopup').fadeIn(200);
        $('body').css('overflow', 'hidden');
    }
    
    function hideLoginPopup() {
        $('#loginPopup').fadeOut(200);
        $('body').css('overflow', 'auto');
        $('#popupError').hide();
    }
    
    // Click outside to close
    $(document).on('click', '.login-popup-overlay', function(e) {
        if (e.target === this) {
            hideLoginPopup();
        }
    });
    
    // ESC key to close
    $(document).keydown(function(e) {
        if (e.keyCode === 27) {
            hideLoginPopup();
        }
    });
    
    // Login form submit
    $('#popupLoginForm').submit(function(e) {
        e.preventDefault();
        
        var email = $('#popupEmail').val();
        var password = $('#popupPassword').val();
        var returnUrl = '@Context.Request.Path';
        
        $.ajax({
            url: '/Account/LoginAjax',
            type: 'POST',
            data: {
                email: email,
                password: password,
                returnUrl: returnUrl
            },
            success: function(response) {
                if (response.success) {
                    // Giriş başarılı, sayfayı yenile
                    location.reload();
                } else {
                    // Hata göster
                    $('#popupError').text(response.message).show();
                }
            },
            error: function() {
                $('#popupError').text('Bir hata oluştu. Lütfen tekrar deneyin.').show();
            }
        });
    });
</script>
