@model basics.Areas.Admin.Models.Etkinlik
@{
    ViewData["Title"] = "Bilet Al - " + Model.EtkinlikAdi;
    Layout = "_Layout";
    var biletler = ViewBag.Biletler as List<basics.Areas.Admin.Models.EtkinlikKoltuk>;
    var kategoriler = ViewBag.Kategoriler as List<basics.Areas.Admin.Models.EtkinlikKategori>;
    var kategoriSatisSayilari = ViewBag.KategoriSatisSayilari as Dictionary<int, int>;
    var satisTipi = ViewBag.SatisTipi as string ?? "Koltuk";
    var biletFiyati = ViewBag.BiletFiyati as decimal? ?? 150m;
}

<link rel="stylesheet" href="~/css/bilet-style.css?v=3" />

<div class="bilet-page-new">
    <!-- Header: Etkinlik Bilgileri -->
    <div class="bilet-header-bar">
        <div class="header-left">
            <div class="event-poster">
                <div class="poster-placeholder">
                    <i class="fas fa-theater-masks"></i>
                </div>
            </div>
            <div class="event-info-compact">
                <h1>@Model.EtkinlikAdi</h1>
                <div class="event-meta">
                    <span><i class="fas fa-map-marker-alt"></i> @Model.Salon?.SalonAdi, @Model.Salon?.Sehir</span>
                    <span><i class="fas fa-calendar-alt"></i> @Model.TarihSaat.ToString("dd MMMM yyyy, dddd")</span>
                    <span><i class="fas fa-clock"></i> @Model.TarihSaat.ToString("HH:mm")</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <a asp-action="Index" class="btn-back-small">
                <i class="fas fa-arrow-left"></i>
                <span>Geri</span>
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    }

    <!-- Main Content -->
    <div class="bilet-main-content">
        
        @if (satisTipi == "Kategori")
        {
            <!-- KATEGORİ SATIŞI -->
            <style>
                .kategori-overlay {
                    position: relative;
                    width: 100%;
                }
                .blurred-seats {
                    filter: blur(8px);
                    opacity: 0.4;
                    pointer-events: none;
                    user-select: none;
                }
                .kategori-cards-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 10;
                    padding: 2rem;
                }
                .kategori-warning {
                    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 12px;
                    margin-bottom: 2rem;
                    text-align: center;
                    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
                    max-width: 600px;
                }
                .kategori-warning i {
                    font-size: 1.5rem;
                    margin-right: 0.5rem;
                }
                .kategori-cards {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1.5rem;
                    justify-content: center;
                    max-width: 900px;
                }
                .kategori-card {
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
                    padding: 1.5rem;
                    min-width: 220px;
                    text-align: center;
                    transition: transform 0.3s, box-shadow 0.3s;
                    cursor: pointer;
                    border: 3px solid transparent;
                }
                .kategori-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 12px 40px rgba(0,0,0,0.2);
                    border-color: #28a745;
                }
                .kategori-card.tukendi {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                .kategori-card.tukendi:hover {
                    transform: none;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
                    border-color: transparent;
                }
                .kategori-name {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: #1a1a2e;
                    margin-bottom: 0.5rem;
                }
                .kategori-price {
                    font-size: 1.8rem;
                    font-weight: 800;
                    color: #28a745;
                    margin-bottom: 0.5rem;
                }
                .kategori-kontenjan {
                    font-size: 0.85rem;
                    color: #6c757d;
                    margin-bottom: 1rem;
                }
                .kategori-btn {
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    color: white;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    border-radius: 25px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    width: 100%;
                    text-decoration: none;
                    display: block;
                }
                .kategori-btn:hover {
                    background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
                    transform: scale(1.05);
                    color: white;
                }
                .kategori-btn.disabled {
                    background: #ccc;
                    cursor: not-allowed;
                }
            </style>
            
            <div class="kategori-overlay">
                <!-- Blur'lu koltuk düzeni arka planda -->
                <div class="seating-wrapper blurred-seats">
                    <div id="seating-area" class="seating-area-fullscreen">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Koltuklar yükleniyor...</span>
                        </div>
                    </div>
                    <div class="stage-bottom">SAHNE</div>
                </div>
                
                <!-- Kategori kartları overlay -->
                <div class="kategori-cards-container">
                    <div class="kategori-warning">
                        <i class="fas fa-info-circle"></i>
                        <strong>Koltuk seçimi gişede yapılacaktır.</strong>
                        <p class="mb-0 mt-2" style="font-size: 0.9rem;">
                            Online satın aldığınız biletinizi gişede göstererek koltuk seçiminizi tamamlayabilirsiniz.
                        </p>
                    </div>
                    
                    <div class="kategori-cards">
                        @if (kategoriler != null && kategoriler.Any())
                        {
                            @foreach (var kat in kategoriler)
                            {
                                var satilanAdet = kategoriSatisSayilari?.ContainsKey(kat.Id) == true ? kategoriSatisSayilari[kat.Id] : 0;
                                var kalanKontenjan = kat.Kontenjan.HasValue ? kat.Kontenjan.Value - satilanAdet : (int?)null;
                                var tukendi = kalanKontenjan.HasValue && kalanKontenjan <= 0;
                                
                                <div class="kategori-card @(tukendi ? "tukendi" : "")">
                                    <div class="kategori-name">@kat.KategoriAdi</div>
                                    <div class="kategori-price">@kat.Fiyat.ToString("N2") ₺</div>
                                    @if (kat.Kontenjan.HasValue)
                                    {
                                        <div class="kategori-kontenjan">
                                            @if (tukendi)
                                            {
                                                <span class="text-danger"><i class="fas fa-times-circle"></i> Tükendi</span>
                                            }
                                            else
                                            {
                                                <span>Kalan: @kalanKontenjan bilet</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="kategori-kontenjan">Sınırsız kontenjan</div>
                                    }
                                    
                                    @if (!tukendi)
                                    {
                                        <a asp-action="KategoriOdeme" asp-route-kategoriId="@kat.Id" asp-route-adet="1" class="kategori-btn">
                                            <i class="fas fa-shopping-cart me-2"></i>Satın Al
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="kategori-btn disabled" disabled>Tükendi</button>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-white">
                                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                                <p>Bu etkinlik için henüz kategori tanımlanmamış.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- KOLTUK SATIŞI (Mevcut davranış) -->
            <!-- Legend Bar with Zoom Controls -->
            <div class="legend-bar">
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-box selected"></div>
                        <span>Seçilen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box sold"></div>
                        <span>Dolu</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box empty"></div>
                        <span>Boş</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box decorative"></div>
                        <span>Kayıt Dışı</span>
                    </div>
                </div>
                
                <!-- Zoom Controls -->
                <div class="zoom-controls">
                    <button type="button" class="zoom-btn" id="zoomOut" title="Uzaklaştır">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button type="button" class="zoom-btn" id="zoomIn" title="Yakınlaştır">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="zoom-btn zoom-fit" id="zoomFit" title="Ekrana Sığdır">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button type="button" class="zoom-btn" id="zoomReset" title="Sıfırla">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </div>

            <!-- Floating Price Card -->
            <div class="price-card-floating">
                <div class="price-card-header">
                    <i class="fas fa-clock"></i>
                    <span>BİLET FİYATLARI</span>
                </div>
                <div class="price-card-body">
                    <div class="price-list">
                        <div class="price-item">
                            <span class="price-amount">@biletFiyati.ToString("N2") ₺</span>
                            <span class="price-type">Tam</span>
                        </div>
                    </div>
                    
                    <!-- Koltuk seçilmeden önce -->
                    <div id="noSeatSelected" class="no-seat-state">
                        <button type="button" class="btn-select-seat">KOLTUK SEÇİNİZ</button>
                    </div>

                    <!-- Koltuk seçildikten sonra -->
                    <div id="seatSelectedState" class="seat-selected-state" style="display: none;">
                        <div class="selected-seats-list">
                            <label>Seçilen Koltuklar:</label>
                            <div id="selectedSeatsList" class="seats-tags"></div>
                        </div>
                        <div class="total-section">
                            <div class="total-row">
                                <span class="total-label">Toplam (<span id="seatCountDisplay">0</span> bilet)</span>
                                <span id="totalPriceDisplay" class="total-amount">0,00 ₺</span>
                            </div>
                        </div>
                        <form asp-action="OdemeYap" method="get" id="paymentForm">
                            <input type="hidden" name="etkinlikId" value="@Model.Id" />
                            <input type="hidden" name="koltuklar" id="selectedSeatsInput" />
                            <input type="hidden" name="toplamFiyat" id="totalPriceInput" />
                            <button type="submit" class="btn-payment">
                                <i class="fas fa-credit-card"></i>
                                <span>Ödeme Yap</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Seating Area - Full Screen with Zoom Support -->
            <div class="seating-wrapper" id="seatingWrapper">
                <div class="seating-zoom-container" id="seatingZoomContainer">
                    <div id="seating-area" class="seating-area-fullscreen">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Koltuklar yükleniyor...</span>
                        </div>
                    </div>
                </div>
                <div class="stage-bottom">SAHNE</div>
            </div>

            <style>
                /* Zoom Controls */
                .legend-bar {
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: flex-start;
                    align-items: center;
                    gap: 15px;
                    padding: 12px 20px;
                    padding-right: 280px; /* Fiyat kartı için boşluk */
                    background: var(--card-bg, #fff);
                    border-radius: 12px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                
                .legend-items {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 15px;
                }
                
                .zoom-controls {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    background: var(--bg-color, #f5f5f5);
                    padding: 6px 12px;
                    border-radius: 25px;
                }
                
                .zoom-btn {
                    width: 36px;
                    height: 36px;
                    border: none;
                    border-radius: 50%;
                    background: var(--card-bg, #fff);
                    color: var(--text-color, #333);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }
                
                .zoom-btn:hover {
                    background: #c8af8b;
                    color: white;
                    transform: scale(1.1);
                }
                
                .zoom-btn:active {
                    transform: scale(0.95);
                }
                
                .zoom-btn.zoom-fit {
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                }
                
                .zoom-btn.zoom-fit:hover {
                    background: linear-gradient(135deg, #20c997, #28a745);
                }
                
                .zoom-level {
                    font-weight: 700;
                    font-size: 0.9rem;
                    min-width: 50px;
                    text-align: center;
                    color: var(--text-color, #333);
                }
                
                /* Seating Zoom Container */
                .seating-wrapper {
                    position: relative;
                    overflow: hidden;
                    border-radius: 12px;
                    background: #111827;
                }
                
                .seating-zoom-container {
                    overflow: auto;
                    max-height: 70vh;
                    min-height: 400px;
                    touch-action: pan-x pan-y;
                    -webkit-overflow-scrolling: touch;
                    padding: 10px;
                }
                
                #seating-area {
                    /* Dinamik boyutlandırma JS tarafından yapılıyor */
                    border-radius: 8px;
                }
                
                /* Mobile optimizations */
                @@media (max-width: 768px) {
                    .legend-bar {
                        flex-direction: column;
                        padding: 10px 15px;
                        padding-right: 15px; /* Mobilde sağ padding'i sıfırla */
                    }
                    
                    .zoom-controls {
                        width: 100%;
                        justify-content: center;
                    }
                    
                    .zoom-btn {
                        width: 44px;
                        height: 44px;
                        font-size: 1.1rem;
                    }
                    
                    .seating-zoom-container {
                        max-height: 55vh;
                        min-height: 300px;
                    }
                    
                    .legend-items {
                        justify-content: center;
                    }
                }
            </style>
        }
    </div>
</div>

<!-- Login Popup Modal -->
@if (!User.IsInRole("Customer"))
{
<div id="loginPopup" class="login-popup-overlay" style="display: none;">
    <div class="login-popup-modal">
        <button type="button" class="popup-close" onclick="hideLoginPopup()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="popup-header">
            <i class="fas fa-user-circle"></i>
            <h3>Giriş Yap</h3>
        </div>
        
        <div class="popup-body">
            <form id="popupLoginForm" method="post">
                <div class="popup-form-group">
                    <label>E-posta</label>
                    <input type="email" id="popupEmail" name="email" class="popup-input" 
                           placeholder="ornek@email.com" required />
                </div>
                
                <div class="popup-form-group">
                    <label>Şifre</label>
                    <input type="password" id="popupPassword" name="password" class="popup-input" 
                           placeholder="••••••" required />
                </div>
                
                <div id="popupError" class="popup-error" style="display: none;"></div>
                
                <div class="popup-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Giriş yapmadan devam ederseniz biletlerinizi sitemiz üzerinden görüntüleyemeyeceksiniz.</span>
                </div>
                
                <a href="javascript:void(0)" class="guest-continue-link" onclick="hideLoginPopup()">
                    <i class="fas fa-arrow-right"></i> Üyeliksiz devam et
                </a>
                
                <button type="submit" class="popup-login-btn">
                    <i class="fas fa-sign-in-alt"></i> Giriş Yap
                </button>
            </form>
            
            <div class="popup-register">
                <p>Hesabınız yok mu?</p>
                <a asp-controller="Account" asp-action="Register" asp-route-returnUrl="@Context.Request.Path">
                    Hemen kayıt olun
                </a>
            </div>
        </div>
    </div>
</div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        var selectedSeats = [];
        var ticketPrice = @biletFiyati;
        
        // Giriş yapmamış kullanıcı için popup'ı otomatik aç
        @if (!User.IsInRole("Customer"))
        {
            <text>
            showLoginPopup();
            </text>
        }
        
        function updateUI() {
            var count = selectedSeats.length;
            var total = count * ticketPrice;
            
            if (count > 0) {
                $('#noSeatSelected').hide();
                $('#seatSelectedState').show();
                
                // Seçilen koltukları listele
                var seatsTags = '';
                selectedSeats.forEach(function(seat) {
                    seatsTags += '<span class="seat-tag">' + seat + '</span>';
                });
                $('#selectedSeatsList').html(seatsTags);
                
                $('#seatCountDisplay').text(count);
                $('#totalPriceDisplay').text(total.toFixed(2).replace('.', ',') + ' ₺');
                $('#selectedSeatsInput').val(selectedSeats.join(','));
                $('#totalPriceInput').val(total);
            } else {
                $('#noSeatSelected').show();
                $('#seatSelectedState').hide();
            }
        }
        
        // --- Zoom ve Koltuk Render Logic ---
        var BASE_SEAT_SIZE = 40;  // Varsayılan koltuk boyutu
        var currentZoom = 1;
        var minZoom = 0.4;
        var maxZoom = 1.5;
        var zoomStep = 0.1;
        
        // Plan verilerini global olarak sakla
        var planJson = null;
        var tickets = [];
        var minX = 0, minY = 0, maxX = 800, maxY = 600;
        
        try {
            // Backend'den gelen veri string ise parse et
            var rawPlan = @Html.Raw(Model.Salon?.SeatingPlan?.PlanJson ?? "{}");
            planJson = typeof rawPlan === 'string' ? JSON.parse(rawPlan) : rawPlan;
            
            var rawTickets = @Html.Raw(Json.Serialize(biletler?.Select(b => new { b.KoltukNo, b.DoluMu })));
            tickets = rawTickets || [];
            
            if (planJson && planJson.koltuklar && planJson.koltuklar.length > 0) {
                // Koordinat sınırlarını hesapla
                maxX = -Infinity;
                maxY = -Infinity;
                minX = Infinity;
                minY = Infinity;

                planJson.koltuklar.forEach(s => {
                    const x = parseFloat(s.x);
                    const y = parseFloat(s.y);
                    if (!isNaN(x)) {
                        if (x > maxX) maxX = x;
                        if (x < minX) minX = x;
                    }
                    if (!isNaN(y)) {
                        if (y > maxY) maxY = y;
                        if (y < minY) minY = y;
                    }
                });

                if (minX === Infinity) minX = 0;
                if (minY === Infinity) minY = 0;
                if (maxX === -Infinity) maxX = 800;
                if (maxY === -Infinity) maxY = 600;
            }
        } catch (err) {
            console.error("Plan parse error:", err);
        }
        
        // Koltukları render et (zoom seviyesine göre)
        function renderSeats() {
            var seatingArea = $('#seating-area');
            seatingArea.empty();
            
            if (!planJson || !planJson.koltuklar || planJson.koltuklar.length === 0) {
                seatingArea.html('<p class="no-seats">Koltuk düzeni bulunamadı.</p>');
                return;
            }
            
            var SEAT_SIZE = Math.round(BASE_SEAT_SIZE * currentZoom);
            var PADDING = Math.round(30 * currentZoom);
            
            // Canvas boyutunu zoom'a göre hesapla
            var scaleRatio = SEAT_SIZE / 40; // Orijinal 40px'e göre oran
            var exactWidth = (maxX - minX) * scaleRatio + SEAT_SIZE + (PADDING * 2);
            var exactHeight = (maxY - minY) * scaleRatio + SEAT_SIZE + (PADDING * 2);
            
            // Scrollable Area Settings
            seatingArea.css({
                'position': 'relative',
                'width': exactWidth + 'px',
                'height': exactHeight + 'px',
                'min-width': exactWidth + 'px',
                'min-height': exactHeight + 'px',
                'background-color': '#111827',
                'margin': '0 auto'
            });

            // Render Loop
            planJson.koltuklar.forEach(function(seat) {
                var seatId = seat.blok + '-' + seat.sira + seat.numara;
                var ticket = tickets.find(t => t.koltukNo === seatId);
                var isSold = ticket && ticket.doluMu;
                var isDecorative = seat.isDecorative === true;

                var seatX = parseFloat(seat.x);
                var seatY = parseFloat(seat.y);
                
                if (isNaN(seatX) || isNaN(seatY)) return;

                // Pozisyonu zoom'a göre ayarla
                var posX = (seatX - minX) * scaleRatio + PADDING;
                var posY = (seatY - minY) * scaleRatio + PADDING;

                var displayText = seat.sira + seat.numara;
                
                // Font boyutunu zoom'a göre ayarla
                var baseFontSize = 11;
                if((displayText + "").length > 3) baseFontSize = 9;
                if((displayText + "").length > 4) baseFontSize = 8;
                var fontSize = Math.max(6, Math.round(baseFontSize * currentZoom)) + 'px';

                var seatEl = $('<div>')
                    .addClass('seat')
                    .text(displayText)
                    .attr('data-seat', seatId)
                    .attr('title', isDecorative ? seat.sira + seat.numara + ' (Kayıt Dışı)' : 'Koltuk: ' + seatId)
                    .css({
                        'position': 'absolute',
                        'left': posX + 'px',
                        'top': posY + 'px',
                        'width': SEAT_SIZE + 'px',
                        'height': SEAT_SIZE + 'px',
                        'display': 'flex',
                        'align-items': 'center',
                        'justify-content': 'center',
                        'font-size': fontSize,
                        'line-height': '1'
                    });
                
                // Seçili koltukları koru
                if (selectedSeats.includes(seatId)) {
                    seatEl.addClass('selected');
                } else if (isDecorative) {
                    seatEl.addClass('decorative');
                } else if (isSold) {
                    seatEl.addClass('sold');
                } else {
                    seatEl.addClass('empty');
                }
                
                // Tıklanabilir koltuklar için event
                if (!isDecorative && !isSold) {
                    seatEl.click(function() {
                        var seatNo = $(this).attr('data-seat');
                        
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected').addClass('empty');
                            selectedSeats = selectedSeats.filter(s => s !== seatNo);
                        } else {
                            $(this).removeClass('empty').addClass('selected');
                            selectedSeats.push(seatNo);
                        }
                        
                        updateUI();
                    });
                }
                
                seatingArea.append(seatEl);
            });
        }
        
        // Zoom level göster
        function updateZoomDisplay() {
            $('#zoomLevel').text(Math.round(currentZoom * 100) + '%');
        }
        
        // Zoom işlemleri
        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
                updateZoomDisplay();
                renderSeats();
            }
        }
        
        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom = Math.max(currentZoom - zoomStep, minZoom);
                updateZoomDisplay();
                renderSeats();
            }
        }
        
        function zoomReset() {
            currentZoom = 1;
            updateZoomDisplay();
            renderSeats();
        }
        
        function zoomFitToScreen() {
            var container = $('#seatingZoomContainer');
            var containerWidth = container.width();
            var containerHeight = container.height();
            
            // Orijinal boyutları hesapla
            var originalWidth = (maxX - minX) + BASE_SEAT_SIZE + 60;
            var originalHeight = (maxY - minY) + BASE_SEAT_SIZE + 60;
            
            // En uygun zoom seviyesini hesapla
            var zoomX = containerWidth / originalWidth;
            var zoomY = containerHeight / originalHeight;
            
            currentZoom = Math.min(zoomX, zoomY) * 0.95;
            currentZoom = Math.max(currentZoom, minZoom);
            currentZoom = Math.min(currentZoom, maxZoom);
            
            updateZoomDisplay();
            renderSeats();
        }
        
        // İlk render
        renderSeats();
        
        // Zoom button event handlers
        $('#zoomIn').click(zoomIn);
        $('#zoomOut').click(zoomOut);
        $('#zoomReset').click(zoomReset);
        $('#zoomFit').click(zoomFitToScreen);
        
        // Keyboard shortcuts
        $(document).on('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                e.preventDefault();
                zoomIn();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                e.preventDefault();
                zoomOut();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                e.preventDefault();
                zoomReset();
            }
        });
        
        // Mouse wheel zoom
        $('#seatingZoomContainer').on('wheel', function(e) {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.originalEvent.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        });
        
        // Mobil için: Sayfa yüklendikten sonra otomatik sığdır
        setTimeout(function() {
            if ($(window).width() <= 768) {
                zoomFitToScreen();
            }
        }, 300);
    });

    // Login Popup Functions
    function showLoginPopup() {
        $('#loginPopup').fadeIn(200);
        $('body').css('overflow', 'hidden');
    }
    
    function hideLoginPopup() {
        $('#loginPopup').fadeOut(200);
        $('body').css('overflow', 'auto');
        $('#popupError').hide();
    }
    
    // Click outside to close
    $(document).on('click', '.login-popup-overlay', function(e) {
        if (e.target === this) {
            hideLoginPopup();
        }
    });
    
    // ESC key to close
    $(document).keydown(function(e) {
        if (e.keyCode === 27) {
            hideLoginPopup();
        }
    });
    
    // Login form submit
    $('#popupLoginForm').submit(function(e) {
        e.preventDefault();
        
        var email = $('#popupEmail').val();
        var password = $('#popupPassword').val();
        var returnUrl = '@Context.Request.Path';
        
        $.ajax({
            url: '/Account/LoginAjax',
            type: 'POST',
            data: {
                email: email,
                password: password,
                returnUrl: returnUrl
            },
            success: function(response) {
                if (response.success) {
                    // Giriş başarılı, sayfayı yenile
                    location.reload();
                } else {
                    // Hata göster
                    $('#popupError').text(response.message).show();
                }
            },
            error: function() {
                $('#popupError').text('Bir hata oluştu. Lütfen tekrar deneyin.').show();
            }
        });
    });
</script>
